<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>recur_expansion.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ICAL.Binary.html">Binary</a><ul class='methods'><li data-type='method'><a href="ICAL.Binary.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Binary.html#decodeValue">decodeValue</a></li><li data-type='method'><a href="ICAL.Binary.html#setEncodedValue">setEncodedValue</a></li><li data-type='method'><a href="ICAL.Binary.html#toString">toString</a></li></ul></li><li><a href="ICAL.Component.html">Component</a><ul class='methods'><li data-type='method'><a href="ICAL.Component.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Component.html#addProperty">addProperty</a></li><li data-type='method'><a href="ICAL.Component.html#addPropertyWithValue">addPropertyWithValue</a></li><li data-type='method'><a href="ICAL.Component.html#addSubcomponent">addSubcomponent</a></li><li data-type='method'><a href="ICAL.Component.html#getAllProperties">getAllProperties</a></li><li data-type='method'><a href="ICAL.Component.html#getAllSubcomponents">getAllSubcomponents</a></li><li data-type='method'><a href="ICAL.Component.html#getFirstProperty">getFirstProperty</a></li><li data-type='method'><a href="ICAL.Component.html#getFirstPropertyValue">getFirstPropertyValue</a></li><li data-type='method'><a href="ICAL.Component.html#getFirstSubcomponent">getFirstSubcomponent</a></li><li data-type='method'><a href="ICAL.Component.html#hasProperty">hasProperty</a></li><li data-type='method'><a href="ICAL.Component.html#removeAllProperties">removeAllProperties</a></li><li data-type='method'><a href="ICAL.Component.html#removeAllSubcomponents">removeAllSubcomponents</a></li><li data-type='method'><a href="ICAL.Component.html#removeProperty">removeProperty</a></li><li data-type='method'><a href="ICAL.Component.html#removeSubcomponent">removeSubcomponent</a></li><li data-type='method'><a href="ICAL.Component.html#toJSON">toJSON</a></li><li data-type='method'><a href="ICAL.Component.html#toString">toString</a></li><li data-type='method'><a href="ICAL.Component.html#updatePropertyWithValue">updatePropertyWithValue</a></li></ul></li><li><a href="ICAL.ComponentParser.html">ComponentParser</a><ul class='methods'><li data-type='method'><a href="ICAL.ComponentParser.html#process">process</a></li></ul></li><li><a href="ICAL.Duration.html">Duration</a><ul class='methods'><li data-type='method'><a href="ICAL.Duration.html#.fromData">fromData</a></li><li data-type='method'><a href="ICAL.Duration.html#.fromSeconds">fromSeconds</a></li><li data-type='method'><a href="ICAL.Duration.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Duration.html#.isValueString">isValueString</a></li><li data-type='method'><a href="ICAL.Duration.html#clone">clone</a></li><li data-type='method'><a href="ICAL.Duration.html#compare">compare</a></li><li data-type='method'><a href="ICAL.Duration.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.Duration.html#fromSeconds">fromSeconds</a></li><li data-type='method'><a href="ICAL.Duration.html#normalize">normalize</a></li><li data-type='method'><a href="ICAL.Duration.html#reset">reset</a></li><li data-type='method'><a href="ICAL.Duration.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.Duration.html#toSeconds">toSeconds</a></li><li data-type='method'><a href="ICAL.Duration.html#toString">toString</a></li></ul></li><li><a href="ICAL.Event.html">Event</a><ul class='methods'><li data-type='method'><a href="ICAL.Event.html#findRangeException">findRangeException</a></li><li data-type='method'><a href="ICAL.Event.html#getOccurrenceDetails">getOccurrenceDetails</a></li><li data-type='method'><a href="ICAL.Event.html#getRecurrenceTypes">getRecurrenceTypes</a></li><li data-type='method'><a href="ICAL.Event.html#isRecurrenceException">isRecurrenceException</a></li><li data-type='method'><a href="ICAL.Event.html#isRecurring">isRecurring</a></li><li data-type='method'><a href="ICAL.Event.html#iterator">iterator</a></li><li data-type='method'><a href="ICAL.Event.html#modifiesFuture">modifiesFuture</a></li><li data-type='method'><a href="ICAL.Event.html#relateException">relateException</a></li><li data-type='method'><a href="ICAL.Event.html#toString">toString</a></li></ul></li><li><a href="ICAL.parse.ParserError.html">ParserError</a></li><li><a href="ICAL.Period.html">Period</a><ul class='methods'><li data-type='method'><a href="ICAL.Period.html#.fromData">fromData</a></li><li data-type='method'><a href="ICAL.Period.html#.fromJSON">fromJSON</a></li><li data-type='method'><a href="ICAL.Period.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Period.html#clone">clone</a></li><li data-type='method'><a href="ICAL.Period.html#getDuration">getDuration</a></li><li data-type='method'><a href="ICAL.Period.html#getEnd">getEnd</a></li><li data-type='method'><a href="ICAL.Period.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.Period.html#toJSON">toJSON</a></li><li data-type='method'><a href="ICAL.Period.html#toString">toString</a></li></ul></li><li><a href="ICAL.Property.html">Property</a><ul class='methods'><li data-type='method'><a href="ICAL.Property.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Property.html#getDefaultType">getDefaultType</a></li><li data-type='method'><a href="ICAL.Property.html#getFirstValue">getFirstValue</a></li><li data-type='method'><a href="ICAL.Property.html#getParameter">getParameter</a></li><li data-type='method'><a href="ICAL.Property.html#getValues">getValues</a></li><li data-type='method'><a href="ICAL.Property.html#removeAllValues">removeAllValues</a></li><li data-type='method'><a href="ICAL.Property.html#removeParameter">removeParameter</a></li><li data-type='method'><a href="ICAL.Property.html#resetType">resetType</a></li><li data-type='method'><a href="ICAL.Property.html#setParameter">setParameter</a></li><li data-type='method'><a href="ICAL.Property.html#setValue">setValue</a></li><li data-type='method'><a href="ICAL.Property.html#setValues">setValues</a></li><li data-type='method'><a href="ICAL.Property.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.Property.html#toJSON">toJSON</a></li></ul></li><li><a href="ICAL.Recur.html">Recur</a><ul class='methods'><li data-type='method'><a href="ICAL.Recur.html#._stringToData">_stringToData</a></li><li data-type='method'><a href="ICAL.Recur.html#.fromData">fromData</a></li><li data-type='method'><a href="ICAL.Recur.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Recur.html#.icalDayToNumericDay">icalDayToNumericDay</a></li><li data-type='method'><a href="ICAL.Recur.html#.numericDayToIcalDay">numericDayToIcalDay</a></li><li data-type='method'><a href="ICAL.Recur.html#addComponent">addComponent</a></li><li data-type='method'><a href="ICAL.Recur.html#clone">clone</a></li><li data-type='method'><a href="ICAL.Recur.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.Recur.html#getComponent">getComponent</a></li><li data-type='method'><a href="ICAL.Recur.html#getNextOccurrence">getNextOccurrence</a></li><li data-type='method'><a href="ICAL.Recur.html#isByCount">isByCount</a></li><li data-type='method'><a href="ICAL.Recur.html#isFinite">isFinite</a></li><li data-type='method'><a href="ICAL.Recur.html#iterator">iterator</a></li><li data-type='method'><a href="ICAL.Recur.html#setComponent">setComponent</a></li><li data-type='method'><a href="ICAL.Recur.html#toJSON">toJSON</a></li><li data-type='method'><a href="ICAL.Recur.html#toString">toString</a></li></ul></li><li><a href="ICAL.RecurExpansion.html">RecurExpansion</a><ul class='methods'><li data-type='method'><a href="ICAL.RecurExpansion.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.RecurExpansion.html#next">next</a></li><li data-type='method'><a href="ICAL.RecurExpansion.html#toJSON">toJSON</a></li></ul></li><li><a href="ICAL.RecurIterator.html">RecurIterator</a><ul class='methods'><li data-type='method'><a href="ICAL.RecurIterator.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.RecurIterator.html#next">next</a></li><li data-type='method'><a href="ICAL.RecurIterator.html#toJSON">toJSON</a></li></ul></li><li><a href="ICAL.Time.html">Time</a><ul class='methods'><li data-type='method'><a href="ICAL.Time.html#.daysInMonth">daysInMonth</a></li><li data-type='method'><a href="ICAL.Time.html#.fromData">fromData</a></li><li data-type='method'><a href="ICAL.Time.html#.fromDateString">fromDateString</a></li><li data-type='method'><a href="ICAL.Time.html#.fromDateTimeString">fromDateTimeString</a></li><li data-type='method'><a href="ICAL.Time.html#.fromDayOfYear">fromDayOfYear</a></li><li data-type='method'><a href="ICAL.Time.html#.fromJSDate">fromJSDate</a></li><li data-type='method'><a href="ICAL.Time.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.Time.html#.fromStringv2">fromStringv2</a></li><li data-type='method'><a href="ICAL.Time.html#.getDominicalLetter">getDominicalLetter</a></li><li data-type='method'><a href="ICAL.Time.html#.isLeapYear">isLeapYear</a></li><li data-type='method'><a href="ICAL.Time.html#.now">now</a></li><li data-type='method'><a href="ICAL.Time.html#.weekOneStarts">weekOneStarts</a></li><li data-type='method'><a href="ICAL.Time.html#addDuration">addDuration</a></li><li data-type='method'><a href="ICAL.Time.html#adjust">adjust</a></li><li data-type='method'><a href="ICAL.Time.html#clone">clone</a></li><li data-type='method'><a href="ICAL.Time.html#compare">compare</a></li><li data-type='method'><a href="ICAL.Time.html#compareDateOnlyTz">compareDateOnlyTz</a></li><li data-type='method'><a href="ICAL.Time.html#convertToZone">convertToZone</a></li><li data-type='method'><a href="ICAL.Time.html#dayOfWeek">dayOfWeek</a></li><li data-type='method'><a href="ICAL.Time.html#dayOfYear">dayOfYear</a></li><li data-type='method'><a href="ICAL.Time.html#endOfMonth">endOfMonth</a></li><li data-type='method'><a href="ICAL.Time.html#endOfWeek">endOfWeek</a></li><li data-type='method'><a href="ICAL.Time.html#endOfYear">endOfYear</a></li><li data-type='method'><a href="ICAL.Time.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.Time.html#fromJSDate">fromJSDate</a></li><li data-type='method'><a href="ICAL.Time.html#fromUnixTime">fromUnixTime</a></li><li data-type='method'><a href="ICAL.Time.html#getDominicalLetter">getDominicalLetter</a></li><li data-type='method'><a href="ICAL.Time.html#isNthWeekDay">isNthWeekDay</a></li><li data-type='method'><a href="ICAL.Time.html#nthWeekDay">nthWeekDay</a></li><li data-type='method'><a href="ICAL.Time.html#reset">reset</a></li><li data-type='method'><a href="ICAL.Time.html#resetTo">resetTo</a></li><li data-type='method'><a href="ICAL.Time.html#startDoyWeek">startDoyWeek</a></li><li data-type='method'><a href="ICAL.Time.html#startOfMonth">startOfMonth</a></li><li data-type='method'><a href="ICAL.Time.html#startOfWeek">startOfWeek</a></li><li data-type='method'><a href="ICAL.Time.html#startOfYear">startOfYear</a></li><li data-type='method'><a href="ICAL.Time.html#subtractDate">subtractDate</a></li><li data-type='method'><a href="ICAL.Time.html#subtractDateTz">subtractDateTz</a></li><li data-type='method'><a href="ICAL.Time.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.Time.html#toJSDate">toJSDate</a></li><li data-type='method'><a href="ICAL.Time.html#toJSON">toJSON</a></li><li data-type='method'><a href="ICAL.Time.html#toString">toString</a></li><li data-type='method'><a href="ICAL.Time.html#toUnixTime">toUnixTime</a></li><li data-type='method'><a href="ICAL.Time.html#utcOffset">utcOffset</a></li><li data-type='method'><a href="ICAL.Time.html#weekNumber">weekNumber</a></li></ul></li><li><a href="ICAL.Timezone.html">Timezone</a><ul class='methods'><li data-type='method'><a href="ICAL.Timezone.html#.convert_time">convert_time</a></li><li data-type='method'><a href="ICAL.Timezone.html#.fromData">fromData</a></li><li data-type='method'><a href="ICAL.Timezone.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.Timezone.html#toString">toString</a></li><li data-type='method'><a href="ICAL.Timezone.html#utcOffset">utcOffset</a></li></ul></li><li><a href="ICAL.UtcOffset.html">UtcOffset</a><ul class='methods'><li data-type='method'><a href="ICAL.UtcOffset.html#.fromSeconds">fromSeconds</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#.fromString">fromString</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#clone">clone</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#compare">compare</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#fromSeconds">fromSeconds</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#toSeconds">toSeconds</a></li><li data-type='method'><a href="ICAL.UtcOffset.html#toString">toString</a></li></ul></li><li><a href="ICAL.VCardTime.html">VCardTime</a><ul class='methods'><li data-type='method'><a href="ICAL.VCardTime.html#.clone">clone</a></li><li data-type='method'><a href="ICAL.VCardTime.html#.fromDateAndOrTimeString">fromDateAndOrTimeString</a></li><li data-type='method'><a href="ICAL.VCardTime.html#.toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.VCardTime.html#.toString">toString</a></li><li data-type='method'><a href="ICAL.VCardTime.html#.utcOffset">utcOffset</a></li><li data-type='method'><a href="ICAL.VCardTime.html#addDuration">addDuration</a></li><li data-type='method'><a href="ICAL.VCardTime.html#adjust">adjust</a></li><li data-type='method'><a href="ICAL.VCardTime.html#clone">clone</a></li><li data-type='method'><a href="ICAL.VCardTime.html#compare">compare</a></li><li data-type='method'><a href="ICAL.VCardTime.html#compareDateOnlyTz">compareDateOnlyTz</a></li><li data-type='method'><a href="ICAL.VCardTime.html#convertToZone">convertToZone</a></li><li data-type='method'><a href="ICAL.VCardTime.html#dayOfWeek">dayOfWeek</a></li><li data-type='method'><a href="ICAL.VCardTime.html#dayOfYear">dayOfYear</a></li><li data-type='method'><a href="ICAL.VCardTime.html#endOfMonth">endOfMonth</a></li><li data-type='method'><a href="ICAL.VCardTime.html#endOfWeek">endOfWeek</a></li><li data-type='method'><a href="ICAL.VCardTime.html#endOfYear">endOfYear</a></li><li data-type='method'><a href="ICAL.VCardTime.html#fromData">fromData</a></li><li data-type='method'><a href="ICAL.VCardTime.html#fromJSDate">fromJSDate</a></li><li data-type='method'><a href="ICAL.VCardTime.html#fromUnixTime">fromUnixTime</a></li><li data-type='method'><a href="ICAL.VCardTime.html#getDominicalLetter">getDominicalLetter</a></li><li data-type='method'><a href="ICAL.VCardTime.html#isNthWeekDay">isNthWeekDay</a></li><li data-type='method'><a href="ICAL.VCardTime.html#nthWeekDay">nthWeekDay</a></li><li data-type='method'><a href="ICAL.VCardTime.html#reset">reset</a></li><li data-type='method'><a href="ICAL.VCardTime.html#resetTo">resetTo</a></li><li data-type='method'><a href="ICAL.VCardTime.html#startDoyWeek">startDoyWeek</a></li><li data-type='method'><a href="ICAL.VCardTime.html#startOfMonth">startOfMonth</a></li><li data-type='method'><a href="ICAL.VCardTime.html#startOfWeek">startOfWeek</a></li><li data-type='method'><a href="ICAL.VCardTime.html#startOfYear">startOfYear</a></li><li data-type='method'><a href="ICAL.VCardTime.html#subtractDate">subtractDate</a></li><li data-type='method'><a href="ICAL.VCardTime.html#subtractDateTz">subtractDateTz</a></li><li data-type='method'><a href="ICAL.VCardTime.html#toICALString">toICALString</a></li><li data-type='method'><a href="ICAL.VCardTime.html#toJSDate">toJSDate</a></li><li data-type='method'><a href="ICAL.VCardTime.html#toJSON">toJSON</a></li><li data-type='method'><a href="ICAL.VCardTime.html#toString">toString</a></li><li data-type='method'><a href="ICAL.VCardTime.html#toUnixTime">toUnixTime</a></li><li data-type='method'><a href="ICAL.VCardTime.html#utcOffset">utcOffset</a></li><li data-type='method'><a href="ICAL.VCardTime.html#weekNumber">weekNumber</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="ICAL.html">ICAL</a><ul class='methods'><li data-type='method'><a href="ICAL.html#.parsefunction">parse</a></li><li data-type='method'><a href="ICAL.html#.stringifyfunction">stringify</a></li></ul></li><li><a href="ICAL.design.html">design</a><ul class='methods'><li data-type='method'><a href="ICAL.design.html#.getDesignSet">getDesignSet</a></li></ul></li><li><a href="ICAL.helpers.html">helpers</a><ul class='methods'><li data-type='method'><a href="ICAL.helpers.html#.binsearchInsert">binsearchInsert</a></li><li data-type='method'><a href="ICAL.helpers.html#.clone">clone</a></li><li data-type='method'><a href="ICAL.helpers.html#.extend">extend</a></li><li data-type='method'><a href="ICAL.helpers.html#.foldline">foldline</a></li><li data-type='method'><a href="ICAL.helpers.html#.formatClassType">formatClassType</a></li><li data-type='method'><a href="ICAL.helpers.html#.inherits">inherits</a></li><li data-type='method'><a href="ICAL.helpers.html#.isStrictlyNaN">isStrictlyNaN</a></li><li data-type='method'><a href="ICAL.helpers.html#.pad2">pad2</a></li><li data-type='method'><a href="ICAL.helpers.html#.strictParseInt">strictParseInt</a></li><li data-type='method'><a href="ICAL.helpers.html#.trunc">trunc</a></li><li data-type='method'><a href="ICAL.helpers.html#.unescapedIndexOf">unescapedIndexOf</a></li></ul></li><li><a href="ICAL.parse.html">parse</a><ul class='methods'><li data-type='method'><a href="ICAL.parse.html#._rfc6868Escape">_rfc6868Escape</a></li><li data-type='method'><a href="ICAL.parse.html#.component">component</a></li><li data-type='method'><a href="ICAL.parse.html#.property">property</a></li></ul></li><li><a href="ICAL.stringify.html">stringify</a><ul class='methods'><li data-type='method'><a href="ICAL.stringify.html#.component">component</a></li><li data-type='method'><a href="ICAL.stringify.html#.multiValue">multiValue</a></li><li data-type='method'><a href="ICAL.stringify.html#.property">property</a></li><li data-type='method'><a href="ICAL.stringify.html#.propertyValue">propertyValue</a></li><li data-type='method'><a href="ICAL.stringify.html#.value">value</a></li></ul></li><li><a href="ICAL.TimezoneService.html">TimezoneService</a><ul class='methods'><li data-type='method'><a href="ICAL.TimezoneService.html#.get">get</a></li><li data-type='method'><a href="ICAL.TimezoneService.html#.has">has</a></li><li data-type='method'><a href="ICAL.TimezoneService.html#.register">register</a></li><li data-type='method'><a href="ICAL.TimezoneService.html#.remove">remove</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">recur_expansion.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 * Portions Copyright (C) Philipp Kewisch, 2011-2015 */


/**
 * This symbol is further described later on
 * @ignore
 */
ICAL.RecurExpansion = (function() {
  function formatTime(item) {
    return ICAL.helpers.formatClassType(item, ICAL.Time);
  }

  function compareTime(a, b) {
    return a.compare(b);
  }

  function isRecurringComponent(comp) {
    return comp.hasProperty('rdate') ||
           comp.hasProperty('rrule') ||
           comp.hasProperty('recurrence-id');
  }

  /**
   * @classdesc
   * Primary class for expanding recurring rules.  Can take multiple rrules,
   * rdates, exdate(s) and iterate (in order) over each next occurrence.
   *
   * Once initialized this class can also be serialized saved and continue
   * iteration from the last point.
   *
   * NOTE: it is intended that this class is to be used
   *       with ICAL.Event which handles recurrence exceptions.
   *
   * @example
   * // assuming event is a parsed ical component
   * var event;
   *
   * var expand = new ICAL.RecurExpansion({
   *   component: event,
   *   dtstart: event.getFirstPropertyValue('dtstart')
   * });
   *
   * // remember there are infinite rules
   * // so its a good idea to limit the scope
   * // of the iterations then resume later on.
   *
   * // next is always an ICAL.Time or null
   * var next;
   *
   * while (someCondition &amp;&amp; (next = expand.next())) {
   *   // do something with next
   * }
   *
   * // save instance for later
   * var json = JSON.stringify(expand);
   *
   * //...
   *
   * // NOTE: if the component's properties have
   * //       changed you will need to rebuild the
   * //       class and start over. This only works
   * //       when the component's recurrence info is the same.
   * var expand = new ICAL.RecurExpansion(JSON.parse(json));
   *
   * @description
   * The options object can be filled with the specified initial values. It can
   * also contain additional members, as a result of serializing a previous
   * expansion state, as shown in the example.
   *
   * @class
   * @alias ICAL.RecurExpansion
   * @param {Object} options
   *        Recurrence expansion options
   * @param {ICAL.Time} options.dtstart
   *        Start time of the event
   * @param {ICAL.Component=} options.component
   *        Component for expansion, required if not resuming.
   */
  function RecurExpansion(options) {
    this.ruleDates = [];
    this.exDates = [];
    this.fromData(options);
  }

  RecurExpansion.prototype = {
    /**
     * True when iteration is fully completed.
     * @type {Boolean}
     */
    complete: false,

    /**
     * Array of rrule iterators.
     *
     * @type {ICAL.RecurIterator[]}
     * @private
     */
    ruleIterators: null,

    /**
     * Array of rdate instances.
     *
     * @type {ICAL.Time[]}
     * @private
     */
    ruleDates: null,

    /**
     * Array of exdate instances.
     *
     * @type {ICAL.Time[]}
     * @private
     */
    exDates: null,

    /**
     * Current position in ruleDates array.
     * @type {Number}
     * @private
     */
    ruleDateInc: 0,

    /**
     * Current position in exDates array
     * @type {Number}
     * @private
     */
    exDateInc: 0,

    /**
     * Current negative date.
     *
     * @type {ICAL.Time}
     * @private
     */
    exDate: null,

    /**
     * Current additional date.
     *
     * @type {ICAL.Time}
     * @private
     */
    ruleDate: null,

    /**
     * Start date of recurring rules.
     *
     * @type {ICAL.Time}
     */
    dtstart: null,

    /**
     * Last expanded time
     *
     * @type {ICAL.Time}
     */
    last: null,

    /**
     * Initialize the recurrence expansion from the data object. The options
     * object may also contain additional members, see the
     * {@link ICAL.RecurExpansion constructor} for more details.
     *
     * @param {Object} options
     *        Recurrence expansion options
     * @param {ICAL.Time} options.dtstart
     *        Start time of the event
     * @param {ICAL.Component=} options.component
     *        Component for expansion, required if not resuming.
     */
    fromData: function(options) {
      var start = ICAL.helpers.formatClassType(options.dtstart, ICAL.Time);

      if (!start) {
        throw new Error('.dtstart (ICAL.Time) must be given');
      } else {
        this.dtstart = start;
      }

      if (options.component) {
        this._init(options.component);
      } else {
        this.last = formatTime(options.last) || start.clone();

        if (!options.ruleIterators) {
          throw new Error('.ruleIterators or .component must be given');
        }

        this.ruleIterators = options.ruleIterators.map(function(item) {
          return ICAL.helpers.formatClassType(item, ICAL.RecurIterator);
        });

        this.ruleDateInc = options.ruleDateInc;
        this.exDateInc = options.exDateInc;

        if (options.ruleDates) {
          this.ruleDates = options.ruleDates.map(formatTime);
          this.ruleDate = this.ruleDates[this.ruleDateInc];
        }

        if (options.exDates) {
          this.exDates = options.exDates.map(formatTime);
          this.exDate = this.exDates[this.exDateInc];
        }

        if (typeof(options.complete) !== 'undefined') {
          this.complete = options.complete;
        }
      }
    },

    /**
     * Retrieve the next occurrence in the series.
     * @return {ICAL.Time}
     */
    next: function() {
      var iter;
      var ruleOfDay;
      var next;
      var compare;

      var maxTries = 500;
      var currentTry = 0;

      while (true) {
        if (currentTry++ > maxTries) {
          throw new Error(
            'max tries have occured, rule may be impossible to forfill.'
          );
        }

        next = this.ruleDate;
        iter = this._nextRecurrenceIter(this.last);

        // no more matches
        // because we increment the rule day or rule
        // _after_ we choose a value this should be
        // the only spot where we need to worry about the
        // end of events.
        if (!next &amp;&amp; !iter) {
          // there are no more iterators or rdates
          this.complete = true;
          break;
        }

        // no next rule day or recurrence rule is first.
        if (!next || (iter &amp;&amp; next.compare(iter.last) > 0)) {
          // must be cloned, recur will reuse the time element.
          next = iter.last.clone();
          // move to next so we can continue
          iter.next();
        }

        // if the ruleDate is still next increment it.
        if (this.ruleDate === next) {
          this._nextRuleDay();
        }

        this.last = next;

        // check the negative rules
        if (this.exDate) {
          compare = this.exDate.compare(this.last);

          if (compare &lt; 0) {
            this._nextExDay();
          }

          // if the current rule is excluded skip it.
          if (compare === 0) {
            this._nextExDay();
            continue;
          }
        }

        //XXX: The spec states that after we resolve the final
        //     list of dates we execute exdate this seems somewhat counter
        //     intuitive to what I have seen most servers do so for now
        //     I exclude based on the original date not the one that may
        //     have been modified by the exception.
        return this.last;
      }
    },

    /**
     * Converts object into a serialize-able format. This format can be passed
     * back into the expansion to resume iteration.
     * @return {Object}
     */
    toJSON: function() {
      function toJSON(item) {
        return item.toJSON();
      }

      var result = Object.create(null);
      result.ruleIterators = this.ruleIterators.map(toJSON);

      if (this.ruleDates) {
        result.ruleDates = this.ruleDates.map(toJSON);
      }

      if (this.exDates) {
        result.exDates = this.exDates.map(toJSON);
      }

      result.ruleDateInc = this.ruleDateInc;
      result.exDateInc = this.exDateInc;
      result.last = this.last.toJSON();
      result.dtstart = this.dtstart.toJSON();
      result.complete = this.complete;

      return result;
    },

    /**
     * Extract all dates from the properties in the given component. The
     * properties will be filtered by the property name.
     *
     * @private
     * @param {ICAL.Component} component        The component to search in
     * @param {String} propertyName             The property name to search for
     * @return {ICAL.Time[]}                    The extracted dates.
     */
    _extractDates: function(component, propertyName) {
      function handleProp(prop) {
        idx = ICAL.helpers.binsearchInsert(
          result,
          prop,
          compareTime
        );

        // ordered insert
        result.splice(idx, 0, prop);
      }

      var result = [];
      var props = component.getAllProperties(propertyName);
      var len = props.length;
      var i = 0;
      var prop;

      var idx;

      for (; i &lt; len; i++) {
        props[i].getValues().forEach(handleProp);
      }

      return result;
    },

    /**
     * Initialize the recurrence expansion.
     *
     * @private
     * @param {ICAL.Component} component    The component to initialize from.
     */
    _init: function(component) {
      this.ruleIterators = [];

      this.last = this.dtstart.clone();

      // to provide api consistency non-recurring
      // events can also use the iterator though it will
      // only return a single time.
      if (!isRecurringComponent(component)) {
        this.ruleDate = this.last.clone();
        this.complete = true;
        return;
      }

      if (component.hasProperty('rdate')) {
        this.ruleDates = this._extractDates(component, 'rdate');

        // special hack for cases where first rdate is prior
        // to the start date. We only check for the first rdate.
        // This is mostly for google's crazy recurring date logic
        // (contacts birthdays).
        if ((this.ruleDates[0]) &amp;&amp;
            (this.ruleDates[0].compare(this.dtstart) &lt; 0)) {

          this.ruleDateInc = 0;
          this.last = this.ruleDates[0].clone();
        } else {
          this.ruleDateInc = ICAL.helpers.binsearchInsert(
            this.ruleDates,
            this.last,
            compareTime
          );
        }

        this.ruleDate = this.ruleDates[this.ruleDateInc];
      }

      if (component.hasProperty('rrule')) {
        var rules = component.getAllProperties('rrule');
        var i = 0;
        var len = rules.length;

        var rule;
        var iter;

        for (; i &lt; len; i++) {
          rule = rules[i].getFirstValue();
          iter = rule.iterator(this.dtstart);
          this.ruleIterators.push(iter);

          // increment to the next occurrence so future
          // calls to next return times beyond the initial iteration.
          // XXX: I find this suspicious might be a bug?
          iter.next();
        }
      }

      if (component.hasProperty('exdate')) {
        this.exDates = this._extractDates(component, 'exdate');
        // if we have a .last day we increment the index to beyond it.
        this.exDateInc = ICAL.helpers.binsearchInsert(
          this.exDates,
          this.last,
          compareTime
        );

        this.exDate = this.exDates[this.exDateInc];
      }
    },

    /**
     * Advance to the next exdate
     * @private
     */
    _nextExDay: function() {
      this.exDate = this.exDates[++this.exDateInc];
    },

    /**
     * Advance to the next rule date
     * @private
     */
    _nextRuleDay: function() {
      this.ruleDate = this.ruleDates[++this.ruleDateInc];
    },

    /**
     * Find and return the recurrence rule with the most recent event and
     * return it.
     *
     * @private
     * @return {?ICAL.RecurIterator}    Found iterator.
     */
    _nextRecurrenceIter: function() {
      var iters = this.ruleIterators;

      if (iters.length === 0) {
        return null;
      }

      var len = iters.length;
      var iter;
      var iterTime;
      var iterIdx = 0;
      var chosenIter;

      // loop through each iterator
      for (; iterIdx &lt; len; iterIdx++) {
        iter = iters[iterIdx];
        iterTime = iter.last;

        // if iteration is complete
        // then we must exclude it from
        // the search and remove it.
        if (iter.completed) {
          len--;
          if (iterIdx !== 0) {
            iterIdx--;
          }
          iters.splice(iterIdx, 1);
          continue;
        }

        // find the most recent possible choice
        if (!chosenIter || chosenIter.last.compare(iterTime) > 0) {
          // that iterator is saved
          chosenIter = iter;
        }
      }

      // the chosen iterator is returned but not mutated
      // this iterator contains the most recent event.
      return chosenIter;
    }
  };

  return RecurExpansion;
}());
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Wed Apr 13 2016 21:04:52 GMT+0000 (UTC) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
